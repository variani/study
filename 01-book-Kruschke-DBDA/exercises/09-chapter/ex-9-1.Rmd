---
title: "Ex. 9.1"
author: "Andrey Ziyatdinov"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: true
    keep_md: true
---

```{r options, echo = F}
opts_chunk$set(fig.path = "figures-9-1/", comment = NA, results = 'markup', tidy = F, message = F, warning = F, echo = T)
```

### Parameters

```{r par}
dir <- "~/git/variani/study/01-book-Kruschke-DBDA/doc/programs/DBDA2Eprograms"
```

## Include 

```{r inc, cache = F}
library(coda)

library(stats) # `aggregate` function
library(graphics) # `par` function
```

### Include `

```{r src, cache = F}
load_all("~/git/variani/dbda/")
```

## Example `Jags-Ydich-XnomSsubj-MbinomBetaOmegaKappa-Example.R`

See code in the `Jags-Ydich-XnomSsubj-MbinomBetaOmegaKappa-Example.R` file.

### Data

Read data:

```{r dat}
dat <- read.csv(file.path(dir, "TherapeuticTouchData.csv"))
str(dat)
```

Create a data list for JAGS:

```{r dat_list}
y <- dat$y
s <- as.numeric(dat$s) # ensures consecutive integer levels

z <- aggregate(y, by = list(s), FUN = sum)$x
N <- aggregate(rep(1,length(y)), by = list(s), FUN = sum)$x
Nsubj <- length(unique(s))

dataList <- list(z = z, N = N, Nsubj = Nsubj)
```  

Print `dataList`:

```{r dataList}
dataList
```
  
### Model  

```{r mod1}
JagsYdichXnomSsubjMbernBetaOmegaKapp <- function()
{
  out <- list()
  
  # Read The data file:
  out$myData = read.csv(system.file("data", "TherapeuticTouchData.csv", package = "dbda"))
  out$yName = "y" # column name for 0,1 values
  out$sName = "s" # column name for subject ID
  # Optional: Specify filename root and graphical format for saving output.
  # Otherwise specify as NULL or leave saveName and saveType arguments 
  # out of function calls.
  out$fileNameRoot = "Jags-Ydich-XnomSsubj-MbernBetaOmegaKappa-" 
  out$graphFileType = "eps"
  
  out$numSavedSteps = 20000
  out$thinSteps = 10
  
  oldClass(out) <- "JagsYdichXnomSsubjMbernBetaOmegaKapp"
  return(out)
}

mod1 <- JagsYdichXnomSsubjMbernBetaOmegaKapp()
```
  
### MCMC chain  

Generate the MCMC chain:

```{r mcmc, results = 'hide', cache = TRUE}
out <- genMCMC(mod1, data = mod1$myData, sName = mod1$sName, yName = mod1$yName, 
  numSavedSteps = mod1$numSavedSteps, saveName = mod1$fileNameRoot, thinSteps = mod1$thinSteps)
```

### Plot diagnostics

Display diagnostics of chain, for specified parameters:

```{r diag, cache = T}
pnames <- varnames(out)
for(p in pnames[c(1:2, length(pnames) - 1, length(pnames))]) { 
  diagMCMC(out, p)
}
```  
  
### Plot posteriors
  
```{r post, cache = T}
plotMCMC(mod1, out, data = mod1$myData, sName = mod1$sName, yName = mod1$yName, 
  compVal = 0.5 , #rope=c(0.45,0.55) , # Therapeutic touch
  diffIdVec = c(1, 14, 28),              # Therapeutic touch
  compValDiff = 0.0)
```  
  
## Exercise 9.1

```{r kappa_distr_comp}
gammaShRaFromMeanSD(1, 10)
gammaShRaFromModeSD(1, 10)
```

```{r plot_kappa_distr_comp}
xp <- seq(0, 100, by = 0.5)

plot(xp, dgamma(xp, 1.105125, 0.1051249), t = 'l')
lines(xp, dgamma(xp, 0.01, 0.01), col = 'red')

xp <- seq(0.1, 75, by = 0.5)

plot(xp, dgamma(xp, 1.105125, 0.1051249), t = 'l', main = "Between 0.1 and 75: mode-based dominates")
lines(xp, dgamma(xp, 0.01, 0.01), col = 'red')

xp <- seq(0, 0.1, by = 0.5)

plot(xp, dgamma(xp, 1.105125, 0.1051249), t = 'l', main = "Between 0 and 0.1: mean-based dominates")
lines(xp, dgamma(xp, 0.01, 0.01), col = 'red')


xp <- seq(75, 100, by = 0.5)

plot(xp, dgamma(xp, 1.105125, 0.1051249), t = 'l', main = "Between 75 and 100: mean-based dominates")
lines(xp, dgamma(xp, 0.01, 0.01), col = 'red')
```  
  
### Update the model `mod1`

#### MCMC chain  

Generate the MCMC chain:

```{r mcmc2, results = 'hide', cache = TRUE}
out2 <- genMCMC(mod1, data = mod1$myData, sName = mod1$sName, yName = mod1$yName, 
  numSavedSteps = mod1$numSavedSteps, saveName = mod1$fileNameRoot, thinSteps = mod1$thinSteps,
   kappaDist = "Mode1")
```

#### Plot posteriors
  
```{r post2, cache = T}
plotMCMC(mod1, out2, data = mod1$myData, sName = mod1$sName, yName = mod1$yName, 
  compVal = 0.5 , #rope=c(0.45,0.55) , # Therapeutic touch
  diffIdVec = c(1, 14, 28),              # Therapeutic touch
  compValDiff = 0.0)
```           
                      
  
  
  
  
  
  
  
  
  
